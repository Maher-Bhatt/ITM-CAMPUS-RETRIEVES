<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ITM Campus Retrieve - Crypto Crackers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* (same styles as your original; omitted here for brevity in preview) */
        /* Copy the original CSS from your file if you need exact styling */
    </style>
</head>
<body class="antialiased">

  <!-- (Navigation and page markup unchanged) -->
  <!-- ... keep entire page HTML as in your original file ... -->

  <!-- I'll include the key JS below (replace your original <script> block). -->
  <script>
    // ==== CONFIG ====
    // Backend base URL (your Railway public URL)
    const BACKEND_BASE = "https://itm-campus-retrieves-production.up.railway.app";

    // Keep existing global variables / UI state
    const apiKey = "";
    let userKey = localStorage.getItem("gemini_key") || apiKey;
    let currentClaimItem = null;
    let foundItems = [];
    let lostItems = [];

    // --- helper: showToast (unchanged) ---
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgClass = (type === 'success') ? 'bg-gradient-to-r from-emerald-500 to-teal-600' :
                      (type === 'error') ? 'bg-gradient-to-r from-red-500 to-pink-600' :
                      'bg-gradient-to-r from-blue-500 to-indigo-600';
      const icon = (type === 'success') ? 'check-circle' : (type === 'error') ? 'exclamation-circle' : 'info-circle';
      toast.className = `pointer-events-auto flex items-center gap-3 px-6 py-4 rounded-xl shadow-2xl text-white font-bold min-w-[300px] backdrop-blur-md toast-enter ${bgClass}`;
      toast.innerHTML = `<i class="fas fa-${icon} text-xl"></i><span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.remove('toast-enter'); toast.classList.add('toast-exit');
        setTimeout(()=> toast.remove(), 300);
      }, 3000);
    }

    // --- keep your canvas/particles code, etc. (unchanged) ---
    // (If you want me to paste the entire original script, I can - but I'll focus on network changes here.)

    // --- localStorage helpers (unchanged) ---
    function loadData() {
      const storedFound = localStorage.getItem('foundItems');
      const storedLost = localStorage.getItem('lostItems');
      foundItems = storedFound ? JSON.parse(storedFound) : [];
      lostItems = storedLost ? JSON.parse(storedLost) : [];
      updateStats();
    }
    function saveData() {
      localStorage.setItem('foundItems', JSON.stringify(foundItems));
      localStorage.setItem('lostItems', JSON.stringify(lostItems));
      updateStats();
    }
    function updateStats() {
      const sf = document.getElementById('stat-found'); const sl = document.getElementById('stat-lost'); const st = document.getElementById('stat-total');
      if(sf) sf.innerText = foundItems.length;
      if(sl) sl.innerText = lostItems.length;
      if(st) st.innerText = foundItems.length + lostItems.length;
    }

    // --- renderFeed (copied and slightly adjusted) ---
    function renderFeed(){
      const foundContainer = document.getElementById('found-feed');
      const lostContainer = document.getElementById('lost-feed');
      foundContainer.innerHTML = foundItems.length === 0 ? '<p class="text-center text-gray-400 py-4">No found items yet.</p>' :
        foundItems.map((item, index) => `
          <div class="p-4 flex justify-between items-center hover:bg-white/5 transition border-b border-gray-200/10 last:border-0">
            <div class="flex items-start gap-3">
              <div class="bg-emerald-500/20 p-2 rounded-lg text-emerald-400"><i class="fas fa-box"></i></div>
              <div>
                <p class="font-bold text-gray-200 text-sm">${item.name}</p>
                <p class="text-xs text-gray-400 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${item.loc} • ${item.date}</p>
              </div>
            </div>
            <button onclick="openClaimModal(${index})" class="px-3 py-1 bg-emerald-500/10 border border-emerald-500/30 text-emerald-400 text-xs rounded-lg font-bold shadow-sm hover:bg-emerald-500 hover:text-white cursor-pointer transition">Claim</button>
          </div>
        `).join('');
      lostContainer.innerHTML = lostItems.length === 0 ? '<p class="text-center text-gray-400 py-4">No lost items reported.</p>' :
        lostItems.map(item => `
          <div class="p-4 flex justify-between items-center hover:bg-white/5 transition border-b border-gray-200/10 last:border-0">
            <div class="flex items-start gap-3">
              <div class="bg-red-500/20 p-2 rounded-lg text-red-400 flex-shrink-0"><i class="fas fa-search"></i></div>
              <div class="flex-grow">
                <p class="font-bold text-gray-200 text-sm">${item.name}</p>
                <p class="text-xs text-gray-400 mt-1"><i class="fas fa-map-marker-alt mr-1"></i>${item.loc} • ${item.date}</p>
              </div>
              ${item.image ? `<img src="${item.image}" class="w-12 h-12 rounded-lg object-cover border border-white/20 ml-2">` : ''}
            </div>
            <span class="px-3 py-1 bg-white/10 text-gray-400 text-xs rounded-lg font-bold ml-2">Pending</span>
          </div>
        `).join('');
    }

    // --- NEW: network submit to backend ---
    async function submitLostToBackend(formData){
      try {
        const resp = await fetch(`${BACKEND_BASE}/submit_lost`, {
          method: 'POST',
          body: formData
        });
        if(!resp.ok) throw new Error('Network response was not ok: ' + resp.status);
        return await resp.text();
      } catch (e) {
        console.error('submit_lost error', e);
        throw e;
      }
    }
    async function submitFoundToBackend(formData){
      try {
        const resp = await fetch(`${BACKEND_BASE}/submit_found`, { method: 'POST', body: formData });
        if(!resp.ok) throw new Error('Network response was not ok: ' + resp.status);
        return await resp.text();
      } catch (e) {
        console.error('submit_found error', e);
        throw e;
      }
    }

    // --- UPDATED handleReportSubmit: sends to backend and updates UI ---
    async function handleReportSubmit(event, type) {
      event.preventDefault();
      const dateStr = new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      if (type === 'lost') {
        const name = document.getElementById('lost-name').value;
        const loc = document.getElementById('lost-location').value;
        const cat = document.getElementById('lost-category').value;
        const desc = document.getElementById('lost-desc').value;
        const email = document.getElementById('lost-email').value;
        const imageInput = document.getElementById('lost-image');

        // Build FormData for backend (file upload)
        const formData = new FormData();
        formData.append('name', name);
        formData.append('category', cat);
        formData.append('location', loc);
        formData.append('description', desc);
        formData.append('email', email);
        if (imageInput && imageInput.files.length > 0) {
          formData.append('image', imageInput.files[0]);
        }

        // UI optimistic update
        lostItems.unshift({
          name: name, loc: loc, date: dateStr, cat: cat, desc: desc, email: email, image: imageInput && imageInput.files.length>0 ? URL.createObjectURL(imageInput.files[0]) : null
        });
        saveData();
        renderFeed();
        showToast("Submitting lost report to server...", "info");

        // Send to backend
        try {
          await submitLostToBackend(formData);
          showToast("Lost item submitted successfully to server!", "success");
        } catch (err) {
          showToast("Failed to submit lost report to server. Saved locally.", "error");
          console.error(err);
        }

        // run semantic check (optional)
        await checkForMatches(name, desc);
      } else {
        // found
        const name = document.getElementById('found-name').value;
        const loc = document.getElementById('found-location').value;
        const cat = document.getElementById('found-category').value;
        const desc = document.getElementById('found-desc').value;
        const email = document.getElementById('found-email').value;

        const imageInput = document.getElementById('image-upload');

        const formData = new FormData();
        formData.append('name', name);
        formData.append('category', cat);
        formData.append('location', loc);
        formData.append('description', desc);
        formData.append('email', email);
        // security question field id in your form is just an input without id; to include it, add id="found-sq" in markup if you want to pass it.
        const sqInput = document.querySelector('input[placeholder*="lock screen"], input[placeholder*="What is"]');
        if (sqInput) formData.append('sq', sqInput.value);
        if (imageInput && imageInput.files.length > 0) formData.append('image', imageInput.files[0]);

        foundItems.unshift({ name: name, loc: loc, date: dateStr, cat: cat, desc: desc, email: email });
        saveData();
        renderFeed();
        document.getElementById('submission-modal').classList.remove('hidden');
        showToast("Submitting found item to server...", "info");

        try {
          await submitFoundToBackend(formData);
          showToast("Found item submitted successfully to server!", "success");
        } catch (err) {
          showToast("Failed to submit found item to server. Saved locally.", "error");
          console.error(err);
        }
      }
      // reset form
      try { event.target.reset(); } catch(e){}
    }

    // --- existing AI / other helper functions should still work ---
    // keep callGeminiAPI, enhanceDescription, analyzeImage, checkForMatches, etc.
    // (If you want, I can paste the full original functions back here — I left them unchanged above.)

    // --- DOM ready ---
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      renderFeed();
    });

  </script>
</body>
</html>
